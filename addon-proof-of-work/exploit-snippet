#!/usr/bin/env python3

# Snippet taken for GlacierCTF2023 Glacier Military Daemon challenge
# Might need some small fixes, please push them

from pwn import *
from sys import stdout
from subprocess import Popen, PIPE
import os

io = process(['./pow'])

io.recvuntil(b"[$] ")
hashcash = io.recvuntil(b"\n").decode().strip().split(" ")
log.info(f"Received Proof of Work challenge: {hashcash}")

token = ""
if os.getenv("BYPASS_POW", "0") == "1":
    token = os.getenv("POW_DEBUG")
    log.info("Bypassed Proof of Work")
else:
    log.info("Solving Proof of Work, might take a while")
    process = Popen(hashcash, stdout=PIPE) # Yes, this is dangerous if server is malicious
    (output, err) = process.communicate()
    exit_code = process.wait()
    token = output.decode().removesuffix('hashcash token: ').strip()
    log.info(f"Solved Proof of Work: {token}")

io.sendline(token.encode())

a = io.recvline().decode()
if a.find("Proof of work passed"):
    log.info("Server confirmed Proof of Work")
elif a.find("Wrong") or a.find("invalid"):
    log.info("Failed Proof of Work")
    exit(1)
